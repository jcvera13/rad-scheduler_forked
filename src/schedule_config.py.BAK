"""
schedule_config.py — Rotation Pool & Block Scheduling Configuration

Defines all rotation blocks used by engine.py.  The engine processes
blocks in the order listed in SCHEDULING_BLOCKS, enabling interactive
and automated scheduling in a consistent priority order.

Block scheduling order (configurable):
  1. IR shifts first (qualification-gated, 4-person pool)
  2. OFF ALL DAY / IR-CALL marks
  3. M3 (evening, needs early assignment to avoid conflicts)
  4. M0, M1, M2 (remaining inpatient weekday)
  5. Weekend blocks (EP, LP, M0_WEEKEND, Dx-CALL)

See: docs/rotation_configuration.md, docs/architecture.md
"""

from typing import Any, Dict, List, Optional

# ---------------------------------------------------------------------------
# Shift Definitions — all QGenda task names mapped to engine config
# ---------------------------------------------------------------------------
SHIFT_DEFINITIONS: Dict[str, Dict[str, Any]] = {
    # ── Inpatient Weekday (Mercy) ────────────────────────────────────────
    "M0":         {"hours": 2,   "weight": 0.25, "location": "remote",
                   "description": "Helper shift 0700-0800, 1130-1230",
                   "pool": "mercy", "requires": None},
    "M1":         {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "Day shift 0800-1600",
                   "pool": "mercy", "requires": None},
    "M2":         {"hours": 8,   "weight": 1.00, "location": "remote",
                   "description": "Remote 0930-1730",
                   "pool": "mercy", "requires": None},
    "M3":         {"hours": 6,   "weight": 0.75, "location": "remote",
                   "description": "Evening 1600-2200",
                   "pool": "mercy", "requires": None},

    # ── IR (Interventional Radiology) — qualification-gated ─────────────
    "IR-1":       {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "IR Day shift 0800-1600",
                   "pool": "ir",    "requires": "ir"},
    "IR-2":       {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "IR Second shift 0900-1700",
                   "pool": "ir",    "requires": "ir"},
    "IR-CALL":    {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "IR Call / after-hours coverage",
                   "pool": "ir",    "requires": "ir"},
    "PVH-IR":     {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "Providence IR shift",
                   "pool": "ir",    "requires": "ir"},

    # ── Weekend ──────────────────────────────────────────────────────────
    "EP":         {"hours": 6.5, "weight": 0.81, "location": "onsite",
                   "description": "Weekend early 0800-1430",
                   "pool": "weekend", "requires": None},
    "LP":         {"hours": 8.0, "weight": 1.00, "location": "onsite",
                   "description": "Weekend late 1400-2200",
                   "pool": "weekend", "requires": None},
    "M0_WEEKEND": {"hours": 2,   "weight": 0.25, "location": "remote",
                   "description": "Weekend helper 0700-0800, 1130-1230",
                   "pool": "weekend", "requires": None},
    "Dx-CALL":    {"hours": 8,   "weight": 1.00, "location": "remote",
                   "description": "Weekend diagnostic call 1400-2200",
                   "pool": "weekend", "requires": None},

    # ── Subspecialty (fixed assignments — NOT in rotation engine) ────────
    "Skull Base": {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "Fixed subspecialty — neuro/skull_base",
                   "pool": None,    "requires": "skull_base"},
    "Cardiac":    {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "Fixed subspecialty — cardiac",
                   "pool": None,    "requires": "cardiac"},
    "O'Toole":    {"hours": 8,   "weight": 1.00, "location": "onsite",
                   "description": "Fixed subspecialty — mammography/MG",
                   "pool": None,    "requires": "mg"},

    # ── Pseudo-shifts tracked for fairness ───────────────────────────────
    "OFF ALL DAY": {"hours": 0,  "weight": 0.00, "location": None,
                    "description": "Full day off — tracked, not assigned",
                    "pool": None,   "requires": None},
    "VACATION":   {"hours": 0,   "weight": 0.00, "location": None,
                   "description": "Vacation day — skip in cursor",
                   "pool": None,   "requires": None},
}

# ---------------------------------------------------------------------------
# Rotation Pool Configs — passed to engine.schedule_period()
# ---------------------------------------------------------------------------

INPATIENT_WEEKDAY_CONFIG: Dict[str, Any] = {
    "description": "Mercy weekday M0/M1/M2/M3 (19 radiologists, weighted cursor)",
    "pool_filter": "participates_mercy",
    "shifts_per_period": 4,
    "shift_names": ["M0", "M1", "M2", "M3"],
    "shift_weights": {"M0": 0.25, "M1": 1.00, "M2": 1.00, "M3": 0.75},
    "cursor_key": "inpatient_weekday",
    "avoid_previous": False,
    "allow_fallback": True,
    "use_weighted_cursor": True,
    "target_cv": 0.10,
    "schedule_type": "weekday",
}

INPATIENT_WEEKEND_CONFIG: Dict[str, Any] = {
    "description": "Inpatient weekend EP/LP/Dx-CALL (back-to-back avoidance)",
    "pool_filter": "participates_weekend",
    "shifts_per_period": 3,          # 3 Sat + 3 Sun treated as 3-shift weekend unit
    "shift_names": ["M0_WEEKEND", "EP", "Dx-CALL"],
    "shift_weights": {"M0_WEEKEND": 0.25, "EP": 0.81, "LP": 1.00, "Dx-CALL": 1.00},
    "cursor_key": "inpatient_weekend",
    "avoid_previous": True,
    "allow_fallback": True,
    "use_weighted_cursor": True,
    "target_cv": 0.10,
    "schedule_type": "weekend",
}

IR_WEEKDAY_CONFIG: Dict[str, Any] = {
    "description": "IR weekday IR-1/IR-2 (4-person qualified pool)",
    "pool_filter": "participates_ir",
    "shifts_per_period": 2,
    "shift_names": ["IR-1", "IR-2"],
    "shift_weights": {"IR-1": 1.00, "IR-2": 1.00},
    "cursor_key": "ir_weekday",
    "avoid_previous": False,
    "allow_fallback": True,
    "use_weighted_cursor": True,
    "target_cv": 0.10,
    "schedule_type": "weekday",
}

# ---------------------------------------------------------------------------
# BLOCK SCHEDULING ORDER
# The engine processes these blocks in sequence for each scheduling period.
# This defines "interactive scheduling": IR first → Off marks → M3 → M0/M1/M2
# Each block is a dict compatible with engine.schedule_block().
# ---------------------------------------------------------------------------
SCHEDULING_BLOCKS: List[Dict[str, Any]] = [
    # Block 1: IR first — qualification-gated, must be resolved before
    # general rotation to avoid pulling IR staff into Mercy slots
    {
        "block_id": "ir_weekday",
        "label": "IR Shifts (IR-1, IR-2)",
        "config": IR_WEEKDAY_CONFIG,
        "priority": 1,
        "interactive_prompt": "Schedule IR shifts (IR-1, IR-2) for this period?",
        "can_skip": False,
        "subspecialty_gate": "ir",
    },
    # Block 2: M3 second — evening shift, staff availability more constrained
    {
        "block_id": "m3_weekday",
        "label": "M3 Evening Shift",
        "config": {**INPATIENT_WEEKDAY_CONFIG,
                   "shifts_per_period": 1,
                   "shift_names": ["M3"],
                   "shift_weights": {"M3": 0.75},
                   "cursor_key": "inpatient_weekday",
                   "description": "M3 evening block only"},
        "priority": 2,
        "interactive_prompt": "Schedule M3 (evening, 1600-2200) next?",
        "can_skip": False,
        "subspecialty_gate": None,
    },
    # Block 3: M0 helper shift — lowest weight, scheduled after M3
    {
        "block_id": "m0_weekday",
        "label": "M0 Helper Shift",
        "config": {**INPATIENT_WEEKDAY_CONFIG,
                   "shifts_per_period": 1,
                   "shift_names": ["M0"],
                   "shift_weights": {"M0": 0.25},
                   "cursor_key": "inpatient_weekday",
                   "description": "M0 helper block only"},
        "priority": 3,
        "interactive_prompt": "Schedule M0 (helper, 0700-0800/1130-1230) next?",
        "can_skip": False,
        "subspecialty_gate": None,
    },
    # Block 4: M1 + M2 full shifts — bulk of inpatient weekday
    {
        "block_id": "m1m2_weekday",
        "label": "M1 + M2 Day Shifts",
        "config": {**INPATIENT_WEEKDAY_CONFIG,
                   "shifts_per_period": 2,
                   "shift_names": ["M1", "M2"],
                   "shift_weights": {"M1": 1.00, "M2": 1.00},
                   "cursor_key": "inpatient_weekday",
                   "description": "M1+M2 block"},
        "priority": 4,
        "interactive_prompt": "Schedule M1 and M2 (full day shifts) next?",
        "can_skip": False,
        "subspecialty_gate": None,
    },
    # Block 5: Weekend block — back-to-back avoidance active
    {
        "block_id": "inpatient_weekend",
        "label": "Weekend Inpatient (EP, LP, Dx-CALL)",
        "config": INPATIENT_WEEKEND_CONFIG,
        "priority": 5,
        "interactive_prompt": "Schedule weekend inpatient block?",
        "can_skip": True,
        "subspecialty_gate": None,
    },
]

# ---------------------------------------------------------------------------
# Constraint Weights
# ---------------------------------------------------------------------------
CONSTRAINT_WEIGHTS: Dict[str, Any] = {
    "back_to_back_weekend":   {"severity": "soft",  "penalty": 100},
    "vacation_assignment":    {"severity": "hard",  "penalty": 9999},
    "double_booking":         {"severity": "hard",  "penalty": 9999},
    "subspecialty_mismatch":  {"severity": "hard",  "penalty": 9999},
    "fte_overload":           {"severity": "soft",  "penalty": 50},
    "workload_cv_exceeded":   {"severity": "soft",  "penalty": 25},
}

# ---------------------------------------------------------------------------
# Fairness Targets
# ---------------------------------------------------------------------------
FAIRNESS_TARGETS: Dict[str, Any] = {
    "cv_target": 0.10,                # < 10% coefficient of variation
    "max_deviation_from_mean": 0.20,  # ±20% from weighted mean
    "weighted_hours": True,           # Track by weighted hours, not count
    "per_shift_cv_targets": {
        "M0": 0.10,
        "M1": 0.10,
        "M2": 0.10,
        "M3": 0.10,
        "IR-1": 0.10,
        "IR-2": 0.10,
    },
}

# ---------------------------------------------------------------------------
# Subspecialty Fixed Assignments (outside rotation engine)
# ---------------------------------------------------------------------------
FIXED_SUBSPECIALTY_ASSIGNMENTS: Dict[str, List[str]] = {
    # These shifts are NOT run through the rotation engine.
    # Staff are pre-assigned based on qualification.
    "Skull Base": ["JuanCarlos Vera", "James Cooper", "Brian Trinh"],
    "Cardiac":    ["Brian Trinh", "John Johnson"],
    "O'Toole":    ["Karen Yuan", "Kriti Rishi", "Rowena Tena"],
}

# ---------------------------------------------------------------------------
# QGenda task name aliases → engine shift names
# (QGenda uses full names; engine uses short codes)
# ---------------------------------------------------------------------------
QGENDA_TASK_ALIASES: Dict[str, str] = {
    "Mercy 0 (M0)":   "M0",
    "Mercy 1 (M1)":   "M1",
    "Mercy 2 (M2)":   "M2",
    "Mercy 1 (M3)":   "M3",
    "IR-1":           "IR-1",
    "IR-2":           "IR-2",
    "IR-CALL (RMG)":  "IR-CALL",
    "PVH IR":         "PVH-IR",
    "EP 0800-1430":   "EP",
    "LP 1400-2200":   "LP",
    "Dx-CALL1400-2200": "Dx-CALL",
    "OFF ALL DAY":    "OFF ALL DAY",
    "VACATION":       "VACATION",
    "Skull Base":     "Skull Base",
    "Cardiac":        "Cardiac",
    "O'Toole":        "O'Toole",
}
